{% extends "dashboard_base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-people"></i> Kullanıcı Yönetimi</h1>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Kullanıcı Listesi</h5>
                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" id="userSearchInput" class="form-control" placeholder="Kullanıcı ara...">
                </div>
            </div>
            <div class="card-body">
                {% if users %}
                <div class="table-responsive">
                    <table class="table table-hover" id="usersTable">
                        <thead>
                            <tr>
                                <th>Kullanıcı Adı</th>
                                <th>Ad Soyad</th>
                                <th>Roller</th>
                                <th>Uzmanlık Alanı</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            {% for user in users %}
                            <tr data-username="{{ user['username']|lower }}" data-name="{{ user['name']|lower }}" data-roles="{{ user['roles']|join(',')|lower }}" data-expertise="{{ (user.get('expertise_field') or '-')|lower }}">
                                <td>{{ user['username'] }}</td>
                                <td>{{ user['name'] }}</td>
                                <td>
                                    {% for role in user['roles'] %}
                                    <span class="badge bg-primary me-1">{{ role }}</span>
                                    {% endfor %}
                                </td>
                                <td>{{ user.get('expertise_field') or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Kullanıcı listesi sayfalama">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination will be generated by JavaScript -->
                    </ul>
                </nav>
                {% else %}
                <p class="text-muted">Kullanıcı bulunmamaktadır.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Rol Atama -->
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Rol Atama</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('user_management') }}">
                    <input type="hidden" name="action" value="assign_role">
                    <div class="mb-3">
                        <label class="form-label">Kullanıcı</label>
                        <select name="username" class="form-select" required>
                            <option value="">Seçiniz</option>
                            {% for user in users %}
                            <option value="{{ user['username'] }}">{{ user['username'] }} ({{ user['name'] }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rol</label>
                        <select name="role" class="form-select" required>
                            <option value="Editör">Editör</option>
                            <option value="Alan Editörü">Alan Editörü</option>
                            <option value="Hakem">Hakem</option>
                            <option value="Yazar">Yazar</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                    <div class="mb-3" id="expertiseField" style="display: none;">
                        <label class="form-label">Uzmanlık Alanı (Alan Editörü için)</label>
                        <select name="expertise_field" class="form-select">
                            <option value="">Seçiniz</option>
                            <option value="Bilgisayar Mühendisliği">Bilgisayar Mühendisliği</option>
                            <option value="Elektrik-Elektronik Mühendisliği">Elektrik-Elektronik Mühendisliği</option>
                            <option value="Makine Mühendisliği">Makine Mühendisliği</option>
                            <option value="Endüstri Mühendisliği">Endüstri Mühendisliği</option>
                            <option value="İnşaat Mühendisliği">İnşaat Mühendisliği</option>
                            <option value="Kimya Mühendisliği">Kimya Mühendisliği</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Rol Ata</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Rol Silme -->
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">Rol Silme</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('user_management') }}" id="removeRoleForm">
                    <input type="hidden" name="action" value="remove_role">
                    <div class="mb-3">
                        <label class="form-label">Kullanıcı</label>
                        <select name="username" id="removeRoleUsername" class="form-select" required>
                            <option value="">Seçiniz</option>
                            {% for user in users %}
                            <option value="{{ user['username'] }}">{{ user['username'] }} ({{ user['name'] }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Silinecek Rol</label>
                        <select name="role_to_remove" id="roleToRemove" class="form-select" required>
                            <option value="">Seçiniz</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-danger w-100">Rolü Sil</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Yeni Kullanıcı -->
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Yeni Kullanıcı</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('user_management') }}">
                    <input type="hidden" name="action" value="create_user">
                    <div class="mb-3">
                        <label class="form-label">Ad Soyad</label>
                        <input type="text" name="new_name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Kullanıcı Adı</label>
                        <input type="text" name="new_username" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Şifre</label>
                        <input type="password" name="new_password" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rol</label>
                        <select name="new_role" class="form-select" required>
                            <option value="Yazar">Yazar</option>
                            <option value="Editör">Editör</option>
                            <option value="Alan Editörü">Alan Editörü</option>
                            <option value="Hakem">Hakem</option>
                        </select>
                    </div>
                    <div class="mb-3" id="newExpertiseField" style="display: none;">
                        <label class="form-label">Uzmanlık Alanı</label>
                        <select name="new_expertise_field" class="form-select">
                            <option value="">Seçiniz</option>
                            <option value="Bilgisayar Mühendisliği">Bilgisayar Mühendisliği</option>
                            <option value="Elektrik-Elektronik Mühendisliği">Elektrik-Elektronik Mühendisliği</option>
                            <option value="Makine Mühendisliği">Makine Mühendisliği</option>
                            <option value="Endüstri Mühendisliği">Endüstri Mühendisliği</option>
                            <option value="İnşaat Mühendisliği">İnşaat Mühendisliği</option>
                            <option value="Kimya Mühendisliği">Kimya Mühendisliği</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Kullanıcı Oluştur</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Şifre Sıfırlama -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">Şifre Sıfırlama</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('user_management') }}">
                    <input type="hidden" name="action" value="reset_password">
                    <div class="mb-3">
                        <label class="form-label">Kullanıcı</label>
                        <select name="reset_username" class="form-select" required>
                            <option value="">Seçiniz</option>
                            {% for user in users %}
                            <option value="{{ user['username'] }}">{{ user['username'] }} ({{ user['name'] }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Yeni Şifre</label>
                        <input type="password" name="reset_password" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-warning w-100">Şifreyi Sıfırla</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Kullanıcı Silme -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">Kullanıcı Silme</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('user_management') }}" onsubmit="return confirm('Bu kullanıcıyı silmek istediğinizden emin misiniz?');">
                    <input type="hidden" name="action" value="delete_user">
                    <div class="mb-3">
                        <label class="form-label">Kullanıcı</label>
                        <select name="delete_username" class="form-select" required>
                            <option value="">Seçiniz</option>
                            {% for user in users %}
                            {% if user['username'] != 'admin' %}
                            <option value="{{ user['username'] }}">{{ user['username'] }} ({{ user['name'] }})</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-danger w-100">Kullanıcıyı Sil</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Tüm JavaScript kodlarını DOMContentLoaded içinde çalıştır
document.addEventListener('DOMContentLoaded', function() {
    // Alan Editörü seçildiğinde uzmanlık alanı göster
    const roleSelect = document.querySelector('select[name="role"]');
    if (roleSelect) {
        roleSelect.addEventListener('change', function() {
            const expertiseField = document.getElementById('expertiseField');
            if (expertiseField) {
                if (this.value === 'Alan Editörü') {
                    expertiseField.style.display = 'block';
                } else {
                    expertiseField.style.display = 'none';
                }
            }
        });
    }

    const newRoleSelect = document.querySelector('select[name="new_role"]');
    if (newRoleSelect) {
        newRoleSelect.addEventListener('change', function() {
            const newExpertiseField = document.getElementById('newExpertiseField');
            if (newExpertiseField) {
                if (this.value === 'Alan Editörü') {
                    newExpertiseField.style.display = 'block';
                } else {
                    newExpertiseField.style.display = 'none';
                }
            }
        });
    }

    // Kullanıcı seçildiğinde mevcut rollerini göster (Rol Silme formu için)
    const removeRoleUsername = document.getElementById('removeRoleUsername');
    const roleToRemove = document.getElementById('roleToRemove');
    
    if (removeRoleUsername && roleToRemove) {
        removeRoleUsername.addEventListener('change', function() {
            const username = this.value;
            
            roleToRemove.innerHTML = '<option value="">Seçiniz</option>';
            
            if (username) {
                // Kullanıcı bilgilerini al
                const userRoles = {
                    {% for user in users %}
                    '{{ user['username'] }}': {{ user['roles']|tojson }},
                    {% endfor %}
                };
                
                if (userRoles[username]) {
                    userRoles[username].forEach(function(role) {
                        if (role !== 'Admin') {
                            const option = document.createElement('option');
                            option.value = role;
                            option.textContent = role;
                            roleToRemove.appendChild(option);
                        }
                    });
                }
            }
        });
    }

    // Kullanıcı listesi arama ve sayfalama
    (function() {
        const searchInput = document.getElementById('userSearchInput');
        const tableBody = document.getElementById('usersTableBody');
        const pagination = document.getElementById('pagination');
        const rowsPerPage = 10;
        let currentPage = 1;
        let filteredRows = [];

        if (!searchInput || !tableBody || !pagination) return;

        // Tüm satırları al
        function getAllRows() {
            return Array.from(tableBody.querySelectorAll('tr'));
        }

        // Arama fonksiyonu
        function filterRows() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const allRows = getAllRows();
            
            if (searchTerm === '') {
                filteredRows = allRows;
            } else {
                filteredRows = allRows.filter(row => {
                    const username = row.getAttribute('data-username') || '';
                    const name = row.getAttribute('data-name') || '';
                    const roles = row.getAttribute('data-roles') || '';
                    const expertise = row.getAttribute('data-expertise') || '';
                    
                    return username.includes(searchTerm) || 
                           name.includes(searchTerm) || 
                           roles.includes(searchTerm) || 
                           expertise.includes(searchTerm);
                });
            }
            
            currentPage = 1;
            displayRows();
            updatePagination();
        }

        // Satırları göster
        function displayRows() {
            // Tüm satırları gizle
            getAllRows().forEach(row => {
                row.style.display = 'none';
            });

            // Mevcut sayfadaki satırları göster
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const rowsToShow = filteredRows.slice(start, end);

            rowsToShow.forEach(row => {
                row.style.display = '';
            });
        }

        // Sayfalama güncelle
        function updatePagination() {
            const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
            pagination.innerHTML = '';

            if (totalPages <= 1) {
                return;
            }

            // Önceki sayfa butonu
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Önceki">Önceki</a>`;
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    displayRows();
                    updatePagination();
                }
            });
            pagination.appendChild(prevLi);

            // Sayfa numaraları
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                firstLi.innerHTML = `<a class="page-link" href="#">1</a>`;
                firstLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = 1;
                    displayRows();
                    updatePagination();
                });
                pagination.appendChild(firstLi);

                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                    pagination.appendChild(ellipsisLi);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = i;
                    displayRows();
                    updatePagination();
                });
                pagination.appendChild(li);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                    pagination.appendChild(ellipsisLi);
                }

                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                lastLi.innerHTML = `<a class="page-link" href="#">${totalPages}</a>`;
                lastLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = totalPages;
                    displayRows();
                    updatePagination();
                });
                pagination.appendChild(lastLi);
            }

            // Sonraki sayfa butonu
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Sonraki">Sonraki</a>`;
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    displayRows();
                    updatePagination();
                }
            });
            pagination.appendChild(nextLi);
        }

        // Arama input'una event listener ekle
        searchInput.addEventListener('input', filterRows);
        searchInput.addEventListener('keyup', filterRows);

        // İlk yüklemede sayfalama göster
        filterRows();
    })();
});
</script>
{% endblock %}
